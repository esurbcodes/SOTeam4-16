name: CD - Deploy API to Lambda

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "run"
      - "main.py"
      - "requirements.txt"
      - ".github/workflows/lambda_deploy.yml"
  workflow_dispatch:

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest

    # Needed for GitHub â†’ AWS OIDC
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Optional: if you need dependencies vendored into the zip
      - name: Install dependencies into package/
        run: |
          python -m pip install --upgrade pip
          mkdir -p package
          pip install -r requirements.txt -t package

      - name: Build Lambda deployment zip
        run: |
          # Add your source files into the package dir
          cp -r src package/src
          cp run package/run
          cp main.py package/main.py

          cd package
          zip -r ../app.zip .

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: Deploy zip to Lambda
        run: |
          aws lambda update-function-code \
            --function-name SOTeam4P2-Backend \
            --zip-file fileb://app.zip
